<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Implementation Verification Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f9ff; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .warning { background: #fef3c7; color: #92400e; }
        button { 
            margin: 10px; padding: 12px 24px; background: #10b981; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; 
        }
        button:hover { background: #059669; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        pre { white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .status { display: inline-block; width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        .status-pending { background: #fbbf24; }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Implementation Verification Test</h1>
            <p>Testing all four implemented requirements</p>
        </div>

        <div class="section">
            <h3><span class="status status-pending" id="status1"></span>Requirement 1: Question 22 Restriction Removed</h3>
            <p>Testing that post-task survey submission proceeds regardless of Question 22 answer</p>
            <button onclick="testQuestion22Removal()">Test Q22 Restriction Removal</button>
            <div id="q22-result"></div>
        </div>

        <div class="section">
            <h3><span class="status status-pending" id="status2"></span>Requirement 2: Questions 11-15 Saved to search_result_log</h3>
            <p>Testing that search result log data is saved to the correct database table</p>
            <button onclick="testSearchResultLogSaving()">Test Search Result Log Saving</button>
            <div id="search-log-result"></div>
        </div>

        <div class="section">
            <h3><span class="status status-pending" id="status3"></span>Requirement 3: Session-Based Participant IDs</h3>
            <p>Testing that unique participant IDs are generated for multiple users on same device</p>
            <button onclick="testSessionBasedParticipantIDs()">Test Session-Based Participant IDs</button>
            <div id="session-id-result"></div>
        </div>

        <div class="section">
            <h3><span class="status status-pending" id="status4"></span>Requirement 4: Answer Retention for Navigation</h3>
            <p>Testing that answers are retained when users navigate back and forth</p>
            <button onclick="testAnswerRetention()">Test Answer Retention</button>
            <div id="answer-retention-result"></div>
        </div>

        <div class="section">
            <h3>üîÑ Complete End-to-End Test</h3>
            <p>Run all tests together to verify complete implementation</p>
            <button onclick="runCompleteTest()" id="complete-test-btn">Run Complete Test</button>
            <div id="complete-test-result"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://wbguuipoggeamyzrfvbv.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndieHVpaXBwZ2dlYW15enJmdmJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMzNjE3MzUsImV4cCI6MjA0ODkzNzczNX0.PvWfN1fTf2cJfNcCB8_m8l2M_SX2T7E6CX7yOYgLaL8";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function updateStatus(testNumber, success) {
            const statusEl = document.getElementById(`status${testNumber}`);
            statusEl.className = `status ${success ? 'status-success' : 'status-error'}`;
        }

        function generateSessionParticipantId() {
            // Simulate the session-based participant ID generation from sessionManager
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 15);
            const browserFingerprint = getBrowserFingerprint();
            return `session_${timestamp}_${random}_${browserFingerprint}`;
        }

        function getBrowserFingerprint() {
            // Simple browser fingerprint simulation
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (ctx) {
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Browser fingerprint', 2, 2);
            }
            const canvasFingerprint = canvas.toDataURL().slice(-8);
            const screenFingerprint = `${screen.width}x${screen.height}`;
            const timezoneFingerprint = Intl.DateTimeFormat().resolvedOptions().timeZone.slice(-3);
            return `${canvasFingerprint}_${screenFingerprint}_${timezoneFingerprint}`.replace(/[^a-zA-Z0-9]/g, '').substring(0, 12);
        }

        async function testQuestion22Removal() {
            const resultDiv = document.getElementById('q22-result');
            resultDiv.innerHTML = '<div class="info">Testing Question 22 restriction removal...</div>';
            
            try {
                const testParticipantId = generateSessionParticipantId();
                
                // Test with attention_check = 1 (should previously have failed, now should pass)
                const responses = {
                    q16_familiarity: 5,
                    q17_satisfaction: 4,
                    q18_ease_of_use: 6,
                    q19_relevance_google: 5,
                    q20_trust: 4,
                    q21_effectiveness: 5,
                    q22_attention_check: 1, // This used to block submission when it wasn't 3
                    q23_duration: "10-15 minutes",
                    q24_additional_details: "Test feedback"
                };

                const { data, error } = await supabase.functions.invoke('submit-post-task-survey', {
                    body: { participant_id: testParticipantId, responses }
                });

                if (error) {
                    throw error;
                }

                if (data && data.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Success! Question 22 restriction removed</div>
                        <div class="info">Post-task survey submitted with Q22 = 1 (previously would have failed)</div>
                    `;
                    updateStatus(1, true);
                } else {
                    throw new Error(data?.error || 'Submission failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Failed: ${error.message}</div>
                    <div class="warning">Question 22 restriction may still be active</div>
                `;
                updateStatus(1, false);
            }
        }

        async function testSearchResultLogSaving() {
            const resultDiv = document.getElementById('search-log-result');
            resultDiv.innerHTML = '<div class="info">Testing search result log saving to database...</div>';
            
            try {
                const testParticipantId = generateSessionParticipantId();
                const testSessionId = 'test-session-' + Date.now();

                // Test saving questions 11-15 to search_result_log table
                const { data, error } = await supabase.functions.invoke('result-log', {
                    body: {
                        participant_id: testParticipantId,
                        session_id: testSessionId,
                        q11_answer: "iPhone 15 Pro Max",
                        q12_answer: "512gb",
                        q13_answer: "blue",
                        q14_answer: "‚Ç¨1,199",
                        q15_answer: "https://example.com/iphone-15-pro-max"
                    }
                });

                if (error) {
                    throw error;
                }

                if (data && data.ok) {
                    // Verify data was saved correctly
                    const { data: savedData, error: queryError } = await supabase
                        .from('search_result_log')
                        .select('*')
                        .eq('participant_id', testParticipantId)
                        .single();

                    if (queryError) {
                        throw queryError;
                    }

                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Success! Questions 11-15 saved to search_result_log table</div>
                        <div class="info">Data verification:</div>
                        <pre>${JSON.stringify(savedData, null, 2)}</pre>
                    `;
                    updateStatus(2, true);
                } else {
                    throw new Error(data?.error || 'Saving failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Failed: ${error.message}</div>
                    <div class="warning">Search result log saving may not be working correctly</div>
                `;
                updateStatus(2, false);
            }
        }

        async function testSessionBasedParticipantIDs() {
            const resultDiv = document.getElementById('session-id-result');
            resultDiv.innerHTML = '<div class="info">Testing session-based participant ID generation...</div>';
            
            try {
                // Generate multiple participant IDs to test uniqueness
                const ids = [];
                for (let i = 0; i < 5; i++) {
                    ids.push(generateSessionParticipantId());
                    // Small delay to ensure different timestamps
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                // Check that all IDs are unique
                const uniqueIds = new Set(ids);
                const allUnique = uniqueIds.size === ids.length;

                // Check ID format
                const validFormat = ids.every(id => id.startsWith('session_') && id.length > 20);

                if (allUnique && validFormat) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Success! Session-based participant IDs generated correctly</div>
                        <div class="info">Generated ${ids.length} unique IDs:</div>
                        <pre>${ids.map(id => `‚Ä¢ ${id}`).join('\n')}</pre>
                        <div class="info">‚úÖ All IDs are unique and follow session_[timestamp]_[random]_[fingerprint] format</div>
                    `;
                    updateStatus(3, true);
                } else {
                    throw new Error(`ID validation failed - Unique: ${allUnique}, ValidFormat: ${validFormat}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Failed: ${error.message}</div>
                    <div class="warning">Session-based participant ID generation may not be working correctly</div>
                `;
                updateStatus(3, false);
            }
        }

        async function testAnswerRetention() {
            const resultDiv = document.getElementById('answer-retention-result');
            resultDiv.innerHTML = '<div class="info">Testing answer retention functionality...</div>';
            
            try {
                const testParticipantId = generateSessionParticipantId();

                // Test saving answers for different pages
                const testAnswers = {
                    background_survey: {
                        age: "25-34",
                        gender: "non-binary",
                        education: "bachelors"
                    },
                    search_result_log: {
                        smartphone_model: "Samsung Galaxy S24",
                        storage_capacity: "256gb",
                        color: "black",
                        lowest_price: "‚Ç¨849",
                        website_link: "https://example.com/galaxy-s24"
                    },
                    task_instruction: {
                        budget_range: "500-1000"
                    }
                };

                const saveResults = [];
                
                // Test saving for each page
                for (const [pageId, answers] of Object.entries(testAnswers)) {
                    const { data, error } = await supabase.functions.invoke('survey-save', {
                        body: {
                            participant_id: testParticipantId,
                            page_id: pageId,
                            answers: answers
                        }
                    });

                    if (error || !data?.ok) {
                        throw new Error(`Failed to save ${pageId}: ${error?.message || data?.error}`);
                    }
                    saveResults.push(`‚úÖ ${pageId} saved`);
                }

                // Test loading answers back
                const loadResults = [];
                for (const pageId of Object.keys(testAnswers)) {
                    const { data, error } = await supabase.functions.invoke('survey-load', {
                        body: {
                            participant_id: testParticipantId,
                            page_id: pageId
                        }
                    });

                    if (error || !data?.ok) {
                        throw new Error(`Failed to load ${pageId}: ${error?.message || data?.error}`);
                    }

                    if (data.answers) {
                        loadResults.push(`‚úÖ ${pageId} loaded`);
                    } else {
                        loadResults.push(`‚ö†Ô∏è ${pageId} returned null (may be expected)`);
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Success! Answer retention functionality working</div>
                    <div class="info">Save Results:</div>
                    <pre>${saveResults.join('\n')}</pre>
                    <div class="info">Load Results:</div>
                    <pre>${loadResults.join('\n')}</pre>
                    <div class="info">‚úÖ Users can now navigate back and retain their answers</div>
                `;
                updateStatus(4, true);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Failed: ${error.message}</div>
                    <div class="warning">Answer retention may not be working correctly</div>
                `;
                updateStatus(4, false);
            }
        }

        async function runCompleteTest() {
            const resultDiv = document.getElementById('complete-test-result');
            const btn = document.getElementById('complete-test-btn');
            
            btn.disabled = true;
            resultDiv.innerHTML = '<div class="info">üîÑ Running complete implementation test...</div>';
            
            try {
                // Reset all statuses
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`status${i}`).className = 'status status-pending';
                }

                await testQuestion22Removal();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testSearchResultLogSaving();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testSessionBasedParticipantIDs();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testAnswerRetention();

                // Check if all tests passed
                const allPassed = [1, 2, 3, 4].every(i => 
                    document.getElementById(`status${i}`).classList.contains('status-success')
                );

                if (allPassed) {
                    resultDiv.innerHTML = `
                        <div class="success">üéâ All Requirements Successfully Implemented!</div>
                        <div class="info">
                            ‚úÖ Question 22 restriction removed<br>
                            ‚úÖ Questions 11-15 save to search_result_log table<br>
                            ‚úÖ Session-based participant IDs for multi-user support<br>
                            ‚úÖ Answer retention for navigation back/forward<br>
                        </div>
                        <div class="success">üöÄ Your application is ready for user testing!</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">‚ö†Ô∏è Some tests failed - please review results above</div>
                        <div class="info">Check individual test results for details</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Complete test failed: ${error.message}</div>
                `;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
