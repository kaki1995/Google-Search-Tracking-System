<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Query Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; max-height: 300px; overflow-y: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px; }
    </style>
</head>
<body>
    <h1>üîç Search Query & Interaction Test</h1>
    
    <div class="section">
        <h3>Step 1: Test Search via Edge Function</h3>
        <input type="text" id="search-query" placeholder="Enter search query" value="best smartphone 2025">
        <button onclick="testSearchEdgeFunction()">Test Search Edge Function</button>
        <div id="search-result"></div>
    </div>

    <div class="section">
        <h3>Step 2: Test Click Tracking</h3>
        <button onclick="testClickTracking()">Test Click Tracking</button>
        <div id="click-result"></div>
    </div>

    <div class="section">
        <h3>Step 3: Check Database Tables</h3>
        <button onclick="checkAllTables()">Check All Tables</button>
        <div id="check-result"></div>
    </div>

    <div class="section">
        <h3>Step 4: Test Direct Database Insert</h3>
        <button onclick="testDirectQueryInsert()">Test Direct Query Insert</button>
        <div id="direct-result"></div>
    </div>

    <script>
        const SUPABASE_URL = "https://wbguuipoggeamyzrfvbv.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiZ3V1aXBvZ2dlYW15enJmdmJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Nzc2OTksImV4cCI6MjA2OTM1MzY5OX0.ddgmJnxg6hipRZ8_r9WyQpvsM-pkhBlRoybPdtGPEtY";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let testSessionId = null;
        let testQueryId = null;

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Ensure we have a test session
        async function ensureTestSession() {
            if (!testSessionId) {
                testSessionId = generateUUID();
                const { data, error } = await supabase
                    .from('sessions')
                    .insert({
                        id: testSessionId,
                        user_id: 'test-user-search-' + Date.now(),
                        platform: 'Google',
                        device_type: 'desktop',
                        browser: 'Chrome',
                        location: 'Test Location'
                    })
                    .select('id')
                    .single();
                
                if (error) {
                    console.error('Failed to create test session:', error);
                    return false;
                }
                console.log('Test session created:', data.id);
            }
            return true;
        }

        async function testSearchEdgeFunction() {
            const resultDiv = document.getElementById('search-result');
            const queryText = document.getElementById('search-query').value;
            resultDiv.innerHTML = '<div>Testing search edge function...</div>';
            
            try {
                if (!await ensureTestSession()) {
                    resultDiv.innerHTML = '<div class="error">‚ùå Failed to create test session</div>';
                    return;
                }

                console.log('Making request to edge function with session:', testSessionId);
                
                // Test the edge function endpoint
                const response = await fetch("https://wbguuipoggeamyzrfvbv.supabase.co/functions/v1/query", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        session_id: testSessionId,
                        query_text: queryText
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Failed to parse response as JSON</div>
                        <div>Status: ${response.status}</div>
                        <div>Response: ${responseText}</div>
                    `;
                    return;
                }

                console.log('Parsed response:', data);

                if (response.ok && data.query_id) {
                    testQueryId = data.query_id;
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Search successful!</div>
                        <div>Query ID: ${data.query_id}</div>
                        <div>Results: ${data.results ? data.results.length : 0}</div>
                        <div>Total Results: ${data.total_results || 'N/A'}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Search failed (Status: ${response.status})</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå Exception: ${err.message}</div>`;
                console.error('Exception:', err);
            }
        }

        async function testClickTracking() {
            if (!testQueryId) {
                document.getElementById('click-result').innerHTML = '<div class="error">‚ùå Please run search test first</div>';
                return;
            }

            const resultDiv = document.getElementById('click-result');
            resultDiv.innerHTML = '<div>Testing click tracking...</div>';
            
            try {
                const response = await fetch("https://wbguuipoggeamyzrfvbv.supabase.co/functions/v1/log_click", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        query_id: testQueryId,
                        clicked_url: "https://example.com/test-phone",
                        clicked_rank: 1
                    })
                });

                const data = await response.json();
                console.log('Click tracking response:', data);

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Click tracked successfully!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Click tracking failed</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå Exception: ${err.message}</div>`;
                console.error('Exception:', err);
            }
        }

        async function testDirectQueryInsert() {
            const resultDiv = document.getElementById('direct-result');
            resultDiv.innerHTML = '<div>Testing direct query insert...</div>';
            
            try {
                if (!await ensureTestSession()) {
                    resultDiv.innerHTML = '<div class="error">‚ùå Failed to create test session</div>';
                    return;
                }

                const { data, error } = await supabase
                    .from('experiment_queries')
                    .insert({
                        session_id: testSessionId,
                        query_text: 'direct insert test query',
                        reformulation_count: 0
                    })
                    .select('id')
                    .single();

                if (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Direct insert failed: ${error.message}</div>`;
                    console.error('Direct insert error:', error);
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Direct insert successful: ${data.id}</div>`;
                    console.log('Direct insert successful:', data);
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå Exception: ${err.message}</div>`;
                console.error('Exception:', err);
            }
        }

        async function checkAllTables() {
            const resultDiv = document.getElementById('check-result');
            resultDiv.innerHTML = '<div>Checking all tables...</div>';
            
            try {
                const tables = {
                    'experiment_queries': await supabase.from('experiment_queries').select('*').order('created_at', { ascending: false }).limit(5),
                    'interactions': await supabase.from('interactions').select('*').order('created_at', { ascending: false }).limit(5),
                    'sessions': await supabase.from('sessions').select('*').order('created_at', { ascending: false }).limit(3)
                };

                let result = '';
                for (const [tableName, tableResult] of Object.entries(tables)) {
                    result += `<h4>${tableName}:</h4>`;
                    if (tableResult.error) {
                        result += `<div class="error">Error: ${tableResult.error.message}</div>`;
                    } else {
                        result += `<div class="success">Records: ${tableResult.data.length}</div>`;
                        result += `<pre>${JSON.stringify(tableResult.data, null, 2)}</pre>`;
                    }
                }

                resultDiv.innerHTML = result;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå Exception: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>
